<!DOCTYPE html><html><head>
<script type="text/javascript" src="https://www.repstatic.it/cless/common/stable/js/vendor/jquery/jquery-1.8.2.min.js"></script>	
<script type="text/javascript" src="https://login.kataweb.it/login/js/api/sso-api.js"></script>
</head>
<body>
<!-- 
https://test-login.kataweb.it/login/docs/SSO-UserGuide.pdf

hashId (richiesto, string) l'hashId dell'utente loggato nell'applicazione (come
restituito dall'SSO nel comando auth), oppure null se nessun utente risulta loggato
• callback (richiesto, function) una funzione javascript che verrà chiamata quando
sarà disponibile l'informazione richiesta. Il parametro che viene restituito nella
callback ha questa struttura:
{
 op: “login”,
 SSID: “<un SSID valido>”
}
le proprietà sono:
◦ op (sempre presente) può valere
▪ login se c'è bisogno di fare un autologin
▪ changeuser se c'è bisogno di un autologin con cambio di utente
▪ login_manual se ci sarebbe bisogno di un autologin, ma l'utente non può
loggarsi automaticamente su questa applicazione (per esempio perché deve
accettare un contratto aggiuntivo oppure deve inserire delle informazioni
mancanti)
▪ logout se c'è bisogno di un autologout
▪ sameuser se non c'è bisogno di nessuna operazione: l'utente loggato
nell'applicazione coincide con quello loggato sull'SSO
◦ SSID (presente solamente se op è login o changeuser) un SSID valido con il
quale eseguire un'operazione di autologin.

-->
<!-- iframe src="https://login.kataweb.it/login/common/api/sso-frame.jsp?targetDomain=http%3A//www.repubblica.it"></iframe -->
<script type="text/javascript">
window.SSOConf = {
   targetDomain: "test",
   appId:        "repubblica.it"
  }
  

  
/****
var readCookie = function (name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
return null;} 

   

   var readJson = function(){
		var cookieName = 'rid';
		var cookieValue = readCookie(cookieName);
		try { return JSON.parse(unescape(cookieValue.replace(/\\"/g,"\"").replace(/(^"|"$)/g,""))); }
		catch(e){return null;};
	}

	var readCookieandGenerateJson = function(){
		var cookieName = 'rid';
		var cookieValue = readCookie(cookieName);
		var pairs = cookieValue.split('&');
		console.log ("pairs: " + pairs);

		var result = {};
		pairs.forEach(function(pair) {
    		pair = pair.split('=');
    		result[pair[0]] = decodeURIComponent(pair[1] || '');
		});

		try { return JSON.parse(JSON.stringify(result)); }
		catch(e){return null;};
	}

	// var json = readJson();
	var json = readCookieandGenerateJson();
	var hashId = json && json.hash_id ? json.hash_id : null;
	console.log("HashId letto da cookie rid: " + hashId);


 "login": {
        "login": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?rid=READER_ID",
        "loginpw": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?origin=MV_ACC_PAY&rid=READER_ID",
        "registration": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?page=registration&origin=MV_PAY&rid=READER_ID",
        "logout": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/logout?rid=READER_ID",
        "purchase": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/purchase?rid=READER_ID"
    },
rid=amp-F_CTKIHWLtogQ96pwaR5Pw&hash_id=82a75988d61b62fd85325762290334e1

****/


		function QueryStringToJSON() {            
		    var pairs = location.search.slice(1).split('&');
		    
		    var result = {};
		    pairs.forEach(function(pair) {
		        pair = pair.split('=');
		        result[pair[0]] = decodeURIComponent(pair[1] || '');
		    });

		    return JSON.parse(JSON.stringify(result));
		}

		var query_string = QueryStringToJSON();
		console.log("query_string: " + JSON.stringify(query_string))


		var hashId = query_string && query_string.hash_id ? query_string.hash_id : null;
		console.log("HashId letto da query string: " + hashId);

		
		/****
	 	"login": {
	        "login": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?rid=READER_ID",
	        "loginpw": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?origin=MV_ACC_PAY&rid=READER_ID",
	        "registration": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?page=registration&origin=MV_PAY&rid=READER_ID",
	        "logout": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/logout?rid=READER_ID",
	        "purchase": "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/purchase?rid=READER_ID"
	    },
		rid=amp-F_CTKIHWLtogQ96pwaR5Pw&hash_id=82a75988d61b62fd85325762290334e1
		****/


		function AutoLoginCallBack(dati) {
		  var urlTmp = "";
		  var urlCommenti = "";
		  var urlRedirect = "";
		  
		  urlCommenti= "http://dev.repubblica.it:8080/data/test-commenti-rep-orig.html?url="+query_string.url;
		  urlTmp="https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/login?rid="+query_string.rid+"&return="+query_string.return;
		  urlRedirect = "https://tangeri.repubblica.it/test-api/checkpw-v1/premium/amp/logout?rid="+query_string.rid+"&"+"return="+encodeURIComponent(urlTmp);
		  
		  
		  console.log ("Redirect to: " + urlRedirect);
		  console.log ("Return: " + query_string.return);
		  console.log ("Dati: " + JSON.stringify(dati));

		   if ("login" ==  dati.op)   { 
		    //--- non solo loggato sull'applicazione ma lo sono su SSO
		    console.log("AutoLogin - do login");
		    //window.location.href = urlPremiumLogin+dati.SSID;
		   }
		   else  if ("changeuser" ==  dati.op)    {
		    //--- Lo SSO e' loggato con un altro utente: esegui il logout appplicativo del vecchio utente ed esegui login nuovo utente
		    console.log("AutoLogin - do changeuser");
		    window.location.href = urlRedirect;
		   }
		   else  if ("login_manual" ==  dati.op)    {
		    //  forzare il login in modo che questo attivi il flusso di registrazione: nessuna azione automatica eseguita
		    //alert("do login_manual");
		    // console.log("AutoLogin - do login_manual");
		   }
		   else  if ("logout" ==  dati.op)    {
		    //--- logout applicativo (NO SSO) e ritorno sulla home
		    console.log("AutoLogin - do logout");
		    window.location.href = urlRedirect;
		   }
		   else  if ("sameuser" ==  dati.op)    {
		    	//-- nessuna azione presentare la pagina richiesta
			    console.log("AutoLogin - tutto OK");
			    if (dati.hashId){	
				    window.location.href=urlCommenti;
				}
				else {
					window.location.href = urlRedirect;
				}
		   }
		   else {
		    console.log("AutoLogin - ??????????");
		   }
		  }
		// Il terzo parametro è il Reset Status
		SSO.checkStatusChange(hashId, AutoLoginCallBack, true);

</script>

</body></html>